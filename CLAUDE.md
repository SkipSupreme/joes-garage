# Joe's Garage Website V2

## Project Overview
Bicycle repair/rental shop website for Joe's Garage in Calgary, Alberta (joes-garage.ca).
Monorepo with three packages: `packages/frontend` (Astro), `packages/cms` (Payload CMS 3.x), `packages/api` (Express).

## Port Assignments
- **Port 3000**: node-social (PUBLIC-FACING — DO NOT TOUCH OR REASSIGN)
- **Port 3003**: Payload CMS admin panel
- **Port 3001**: Express API (booking system)
- **Port 4321**: Astro frontend dev server

## Database
- PostgreSQL at `postgresql://postgres:postgres@localhost:5434/joes_garage`
- Admin email: `joshhunterduvar@gmail.com`

---

## CRITICAL: Payload CMS 3.x CSS Packaging Bug

**This bug caused extensive debugging time. Do NOT repeat the same investigation.**

### The Problem
`@payloadcms/next` (v3.76.1) uses SWC compilation with a `removedExtensions` array that **strips all `.scss` imports** from compiled JavaScript. This means:

- Template SCSS files (`templates/Default/index.scss`, `templates/Default/Wrapper/index.scss`) are NOT imported in the compiled output
- No `.scss` files ship in `@payloadcms/next/dist/templates/`
- The entire `.template-default` grid layout and `.nav` sidebar positioning CSS is **completely missing** in dev mode
- This causes: nav sidebar full-width and unstyled, no grid layout, content not positioned correctly

Meanwhile, `@payloadcms/ui` components DO keep their SCSS imports (e.g., `NavToggler/index.js` has `import './index.scss'`).

### The Fix (already implemented)
All styles live in `packages/cms/src/app/(payload)/custom.scss` with a three-layer architecture:

1. **`@import '@payloadcms/ui/scss/app.scss'`** — Theme variables, colors, global resets. **NEVER remove this import.**
2. **`@layer payload-default { ... }`** — Missing template/nav CSS extracted from Payload's GitHub source. This is the bug workaround.
3. **Unlayered custom CSS** — Joe's Garage branding (overrides Payload defaults because unlayered CSS beats `@layer` in the CSS cascade).

### Rules
- **NEVER remove the `@import '@payloadcms/ui/scss/app.scss'` line** — it provides ALL theme variables
- **NEVER remove the `@layer payload-default` block** — it contains the missing template grid layout and nav sidebar CSS
- **`packages/cms/src/app/(payload)/layout.tsx`** was auto-generated by Payload but has been patched to fix the `serverFunction` (must call `handleServerFunctions` — the original stub `return args` broke all document drawers). If Payload regenerates this file, re-apply the `handleServerFunctions` fix.
- If styles break, first check that these two sections are intact before investigating other causes
- The production CSS bundle exists at `@payloadcms/next/dist/prod/styles.css` (303KB) but is NOT auto-loaded in dev mode

### Source Files (for reference if Payload version changes)
The missing CSS was extracted from these Payload GitHub source files:
- `packages/next/src/templates/Default/index.scss` — Template container
- `packages/next/src/templates/Default/Wrapper/index.scss` — Grid layout (`display: grid`, `grid-template-columns`)
- `packages/next/src/elements/Nav/index.scss` — Nav sidebar (`position: sticky`, `height: 100vh`)

---

## CRITICAL: Payload CMS 3.x Document Drawer Bug (serverFunction stub)

**This bug caused ALL inline edit drawers to hang at "Loading" forever.**

### The Problem
When Payload auto-generates `packages/cms/src/app/(payload)/layout.tsx`, it creates a stub `serverFunction`:
```typescript
const serverFunction: ServerFunctionClient = async function (args) {
  'use server'
  return args  // BUG: just echoes back arguments
}
```

This breaks ALL document drawers (media edit, testimonial edit, any inline relationship editing). When a drawer calls the server function with `{ name: 'render-document', args: {...} }`, it gets back the raw args instead of the rendered Document component. The drawer checks `result?.Document`, gets `undefined`, and the loading spinner stays forever. **No console errors, no failed network requests** — completely silent failure.

### The Fix (already implemented)
Import and call `handleServerFunctions` from `@payloadcms/next/layouts`:
```typescript
import { handleServerFunctions, RootLayout } from '@payloadcms/next/layouts'

const serverFunction: ServerFunctionClient = async function (args) {
  'use server'
  return handleServerFunctions({
    ...args,
    config,
    importMap,
  })
}
```

### Rules
- If Payload regenerates `layout.tsx` (e.g., during upgrade), **immediately re-apply the `handleServerFunctions` fix**
- The `@payloadcms/next/css` import is NOT needed — our `custom.scss` already handles all CSS
- Confirmed: The `DarkThemeProvider` custom provider does NOT cause this bug (tested by removing it — drawers still broke without the fix)
- Reference: [Payload's own example](https://github.com/payloadcms/payload/blob/main/examples/custom-components/src/app/(payload)/layout.tsx) shows the correct implementation

---

## WORKAROUND: Payload CMS 3.x "Select a file" Button Bug

**This bug caused "Select a file" to do nothing when clicked on media upload fields.**

### The Problem
Payload's Upload component (`@payloadcms/ui/dist/elements/Upload/index.js`) renders:
```html
<input type="file" hidden accept="image/*" class="file-field__hidden-input">
```
When the "Select a file" button is clicked, Payload calls `inputRef.current.click()`. The HTML `hidden` attribute applies `display: none` via the browser's UA stylesheet, and **`.click()` on a `display: none` file input silently fails to open the file dialog** in many browsers.

### The Fix (two layers — both required)

**Layer 1: `FileUploadFix.tsx` provider** (`packages/cms/src/components/admin/FileUploadFix.tsx`)
- Registered as a Payload admin provider in `payload.config.ts`
- Uses a `MutationObserver` to **remove the `hidden` attribute** from file inputs as soon as they appear in the DOM
- Replaces `hidden` with inline styles (position: fixed, off-screen) so the input is invisible but still rendered
- A capture-phase click listener acts as a safety net before Payload's handler fires
- **Does NOT intercept/block events** — lets Payload's native `.click()` handler work

**Layer 2: CSS fallback** (in `custom.scss`)
```css
input[type='file'][hidden],
.file-field__hidden-input {
  display: block !important;
  position: fixed !important;
  top: -9999px !important;
  left: -9999px !important;
  width: 1px !important;
  height: 1px !important;
  opacity: 0.01 !important;
  overflow: hidden !important;
}
```

### Why previous approaches failed
1. **CSS-only** (`display: block !important` on `[hidden]`): Overrides the computed style but some browsers check the `hidden` property/attribute itself, not just computed display
2. **Capture-phase click interception** (calling `e.stopPropagation()` + `fileInput.click()`): Consumed the user gesture context, so the synthetic `.click()` was no longer trusted
3. **The correct approach**: Remove the `hidden` attribute entirely via MutationObserver, then let Payload's own handler call `.click()` on a truly visible element

### Rules
- **NEVER remove `FileUploadFix` from the providers list** in `payload.config.ts`
- **NEVER remove the CSS rule** in `custom.scss` — it's the fallback if JS hasn't run yet
- This is a Payload upstream bug — if fixed in a future version, these workarounds are harmless

### Version Pinning
All Payload packages are pinned to `3.76.1` in `packages/cms/package.json` to prevent breaking updates. Do NOT use `^` ranges for `@payloadcms/*` or `payload`.

---

## Admin Panel Customization

### Custom Components (in `packages/cms/src/components/admin/`)
- `DarkThemeProvider.tsx` — Forces dark theme using `useTheme()` from `@payloadcms/ui`
- `FileUploadFix.tsx` — Fixes "Select a file" button (see workaround section above)
- `Logo.tsx` — Joe's Garage logo (100px height, centered)
- `Icon.tsx` — Small icon variant for favicon/tab
- `BeforeLogin.tsx` — "CONTENT MANAGEMENT SYSTEM" subtitle on login page

### Styling
- All custom SCSS in `packages/cms/src/app/(payload)/custom.scss` (~757 lines)
- Brand color: `#D42B2B` (Joe's Garage red)
- Font: Instrument Sans (Google Fonts)
- CSS cascade: unlayered custom rules override Payload's `@layer payload-default` rules

### Verified Working Pages
- Login, Forgot Password, Dashboard, Collection List, Document Edit, Account, Site Settings
- Mobile responsive (375px iPhone tested)
