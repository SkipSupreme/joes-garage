---
import { Image } from 'astro:assets';
import { getSiteSettings } from '../lib/payload';

const currentPath = Astro.url.pathname;

const links = [
  { href: '/', label: 'Home' },
  { href: '/about', label: 'About' },
  { href: '/services', label: 'Services' },
  { href: '/gallery', label: 'Gallery' },
  { href: '/contact', label: 'Contact' },
];

// Fetch logo from CMS with fallback to public static file
let logoSrc = '/logo.webp';
let logoAlt = "Joe's Garage";
try {
  const settings = await getSiteSettings();
  if (settings?.logo) {
    const cmsUrl = settings.logo.sizes?.medium?.url || settings.logo.url;
    if (cmsUrl) logoSrc = cmsUrl;
    logoAlt = settings.logo.alt || logoAlt;
  }
} catch {
  // CMS unavailable — use static fallback
}
---

<nav
  x-data="{ open: false, scrolled: false }"
  x-init="window.addEventListener('scroll', () => { scrolled = window.scrollY > 20 })"
  :class="scrolled ? 'bg-coal/95 backdrop-blur-md shadow-lg shadow-coal/20' : 'bg-coal'"
  class="fixed top-0 left-0 right-0 z-50 overflow-visible transition-all duration-300"
>
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 overflow-visible">
    <div class="flex h-14 items-center justify-between sm:h-16 lg:h-20 3xl:h-24 overflow-visible">
      <!-- Logo — oversized, shifted down to extend below the nav bar -->
      <a href="/" class="flex items-center group relative z-10">
        <Image
          src={logoSrc}
          alt={logoAlt}
          width={168}
          height={120}
          loading="eager"
          class="relative top-4 sm:top-5 lg:top-8 h-20 sm:h-28 lg:h-36 w-auto transition-transform duration-300 group-hover:scale-105 drop-shadow-lg"
        />
      </a>

      <!-- Desktop links -->
      <div class="hidden lg:flex items-center gap-1 2xl:gap-2 3xl:gap-3">
        {links.map(link => (
          <a
            href={link.href}
            class:list={[
              'px-4 py-2 text-sm 3xl:text-base font-medium rounded-lg transition-all duration-200',
              currentPath === link.href
                ? 'text-amber bg-amber/10'
                : 'text-cream/80 hover:text-cream hover:bg-cream/5',
            ]}
          >
            {link.label}
          </a>
        ))}
        <a
          href="/book"
          data-astro-prefetch
          class:list={[
            'ml-4 px-6 py-2.5 text-sm 3xl:text-base font-bold rounded-lg transition-all duration-200',
            currentPath.startsWith('/book')
              ? 'bg-amber text-coal'
              : 'bg-red text-cream hover:bg-red-light hover:shadow-lg hover:shadow-red/20 hover:-translate-y-0.5',
          ]}
        >
          Book a Bike
        </a>
      </div>

      <!-- Mobile menu button -->
      <button
        @click="open = !open"
        class="lg:hidden relative w-10 h-10 flex items-center justify-center text-cream"
        :aria-expanded="open"
        aria-label="Toggle menu"
      >
        <svg x-show="!open" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
        <svg x-show="open" x-cloak class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile menu -->
  <div
    x-show="open"
    x-cloak
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0 -translate-y-2"
    x-transition:enter-end="opacity-100 translate-y-0"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100 translate-y-0"
    x-transition:leave-end="opacity-0 -translate-y-2"
    @click.outside="open = false"
    class="lg:hidden border-t border-cream/10 bg-coal/98 backdrop-blur-xl shadow-2xl shadow-coal/50"
  >
    <div class="px-4 py-3 space-y-1">
      {links.map(link => (
        <a
          href={link.href}
          class:list={[
            'block px-4 py-3 text-sm font-medium rounded-lg transition-colors',
            currentPath === link.href
              ? 'text-amber bg-amber/10'
              : 'text-cream/80 hover:text-cream hover:bg-cream/5',
          ]}
        >
          {link.label}
        </a>
      ))}
      <a
        href="/book"
        data-astro-prefetch
        class="block mt-2 px-4 py-3 text-sm font-bold text-center rounded-lg bg-red text-cream hover:bg-red-light transition-colors"
      >
        Book a Bike
      </a>
    </div>
  </div>
</nav>

<style>
  [x-cloak] { display: none !important; }
</style>
