---
import { getServices } from '../../lib/payload';
import { sanitizeHtml } from '../../lib/sanitize-html';

interface Props {
  heading?: string;
  subtitle?: string;
  noteText?: string;
}

const { heading, subtitle, noteText } = Astro.props;

let services: any[] = [];
try {
  services = await getServices();
} catch {
  // CMS not available â€” render empty
}
---

<section class="py-10 sm:py-16 lg:py-24">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    {(heading || subtitle) && (
      <div class="text-center max-w-2xl mx-auto mb-8 sm:mb-12">
        {heading && (
          <h2 class="text-2xl sm:text-4xl lg:text-5xl font-display font-extrabold text-coal tracking-tight">
            {heading}
          </h2>
        )}
        {subtitle && (
          <p class="mt-3 text-base sm:text-lg text-ink-muted">
            {subtitle}
          </p>
        )}
      </div>
    )}

    <div class="grid grid-cols-1 md:grid-cols-2 3xl:grid-cols-3 gap-6 3xl:gap-8" data-reveal-stagger>
      {services.map((service: any) => {
        const isPopular = service.name === 'Standard Tune-Up';
        return (
          <div class:list={[
            'group relative p-8 rounded-2xl border transition-all duration-300 hover:-translate-y-1',
            isPopular
              ? 'bg-coal text-cream border-coal-lighter hover:border-amber/30'
              : 'bg-cream-dark border-parchment hover:border-amber/30 hover:shadow-lg hover:shadow-amber/5',
          ]}>
            {isPopular && (
              <div class="absolute top-4 right-4">
                <span class="px-2.5 py-1 text-[10px] font-bold tracking-wider uppercase bg-amber/20 text-amber rounded-full">Most Popular</span>
              </div>
            )}

            <div class="flex items-start justify-between gap-4">
              <div class="flex-1">
                <h3 class:list={[
                  'text-xl font-display font-bold mb-2',
                  isPopular ? 'text-cream' : 'text-coal',
                ]}>
                  {service.name}
                </h3>
                {service.description && (
                  <p class:list={[
                    'leading-relaxed',
                    isPopular ? 'text-cream/60' : 'text-ink-muted',
                  ]}>
                    {typeof service.description === 'string'
                      ? <Fragment set:html={sanitizeHtml(service.description)} />
                      : service.description}
                  </p>
                )}
                {service.estimatedTime && (
                  <div class:list={[
                    'flex items-center gap-3 mt-4 text-sm',
                    isPopular ? 'text-cream/40' : 'text-ink-light',
                  ]}>
                    <span class="flex items-center gap-1">
                      <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                      {service.estimatedTime}
                    </span>
                  </div>
                )}
              </div>
              {service.price != null && (
                <div class="text-right shrink-0">
                  <div class:list={[
                    'text-2xl font-display font-extrabold',
                    isPopular ? 'text-amber' : 'text-coal',
                  ]}>
                    ${service.price}
                  </div>
                  <div class:list={[
                    'text-xs mt-0.5',
                    isPopular ? 'text-cream/40' : 'text-ink-light',
                  ]}>
                    starting at
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      })}
    </div>

    {noteText && (
      <div class="mt-12 p-6 rounded-xl bg-amber/5 border border-amber/15 text-center" data-reveal>
        <p class="text-sm text-ink-muted">
          <Fragment set:html={sanitizeHtml(noteText)} />
        </p>
      </div>
    )}
  </div>
</section>
