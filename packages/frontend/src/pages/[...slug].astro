---
import Base from '../layouts/Base.astro';
import BlockRenderer from '../components/blocks/BlockRenderer.astro';
import { getPage } from '../lib/payload';

// SSR: fetch the page from CMS on each request
const { slug } = Astro.params;

let page: any = null;
try {
  page = slug ? await getPage(slug) : null;
} catch {
  // CMS not available
}

if (!page) {
  return new Response(null, { status: 404 });
}

const { title, layout, meta } = page;
---

<Base
  title={meta?.title || title}
  description={meta?.description || `${title} â€” Joe's Garage`}
  ogImage={meta?.image?.url}
>
  {layout && <BlockRenderer blocks={layout} />}
</Base>
